name: Azure Pipelines
variables:
  python.version: '3.7.6'
stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      name: Hosted Ubuntu 1604
    steps:
    
    - task: DownloadSecureFile@1
      name: InstallSSHKey
      displayName: 'Get SSH Key from sercurefile'
      inputs:
        secureFile: 'id_rsa.pub'
        
    - task: TerraformInstaller@0
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: '0.12.26'
    - script: 'cd terraform/environments/test && terraform init' 
      displayName: 'Initialization Terraform'
    - script:
        cd terraform/environments/test &&
        terraform apply -auto-approve
        -var="public_key_path=$(InstallSSHKey.secureFilePath)"
      displayName: 'Apply Terraform'
    - script: |
        sudo npm install -g newman
        sudo npm install -g newman-reporter-junitfull
      displayName: 'Install Postman Dependencies'
    - script:
        newman run "$(System.DefaultWorkingDirectory)/automatedtesting/postman/data_validation_test.postman_collection.json" -e "$(System.DefaultWorkingDirectory)/automatedtesting/postman/userva.postman_environment.json" -r cli,junitfull --reporter-junitfull-export JUnitReport-data-validation.xml
      displayName: 'Data Validation Test'
    - script:
        newman run "$(System.DefaultWorkingDirectory)/automatedtesting/postman/regression_test.postman_collection.json" -e "$(System.DefaultWorkingDirectory)/automatedtesting/postman/userva.postman_environment.json" -r cli,junitfull --reporter-junitfull-export JUnitReport-regression.xml
      displayName: 'Regression Test'
